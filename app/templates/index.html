<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Facturaci√≥n</title>
    <link rel="stylesheet" href="../static/css/styles.css">
    <script>
        // Configuraci√≥n de variables de entorno para el frontend
        window.API_BASE_URL = '${API_BASE_URL}' || 'http://localhost:5000/api';
    </script>
</head>
<body>
    <div class="container">
        <!-- Navegaci√≥n -->
        <nav class="sidebar">
            <div class="logo">
                <h2>üìä SADI</h2>
                <p>Sistema de Administraci√≥n</p>
            </div>
            <ul class="nav-menu">
                <li><a href="#" data-view="dashboard" class="nav-link active">
                    <span class="icon">üìà</span> Dashboard
                </a></li>
                <li><a href="#" data-view="empresas" class="nav-link">
                    <span class="icon">üè¢</span> Empresas
                </a></li>
                <li><a href="#" data-view="notificaciones" class="nav-link">
                    <span class="icon">üîî</span> Notificaciones
                </a></li>
                <li><a href="#" data-view="triggers" class="nav-link">
                    <span class="icon">‚öôÔ∏è</span> Configuraci√≥n
                </a></li>
                <li><a href="#" data-view="formulario" class="nav-link">
                    <span class="icon">‚ûï</span> Nueva Empresa
                </a></li>
                <li><a href="#" data-view="importacion" class="nav-link">
                    <span class="icon">üì•</span> Importar Excel
                </a></li>
            </ul>
            <div class="user-section">
                <div class="user-info" id="user-info">
                    <span class="user-icon">üë§</span>
                    <span class="user-name" id="user-name">Usuario</span>
                </div>
                <button class="btn-logout" onclick="Auth.logout()" title="Cerrar sesi√≥n">
                    üö™ Salir
                </button>
            </div>
        </nav>

        <!-- Contenido principal -->
        <main class="main-content">
            <header class="header">
                <h1 id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="refreshData()">üîÑ Actualizar</button>
                </div>
            </header>

            <!-- Vista Dashboard -->
            <div id="view-dashboard" class="view active">
                <div class="stats-grid" id="stats-container">
                    <!-- Las estad√≠sticas se cargar√°n aqu√≠ -->
                </div>
                <div class="charts-grid">
                    <div class="card">
                        <h3>Distribuci√≥n por Estado</h3>
                        <div id="chart-estados"></div>
                    </div>
                    <div class="card">
                        <h3>Vencimientos Pr√≥ximos</h3>
                        <div id="chart-vencimientos"></div>
                    </div>
                </div>
            </div>

            <!-- Vista Empresas -->
            <div id="view-empresas" class="view">
                <div class="filters-bar">
                    <input type="text" id="search-empresas" class="search-input" placeholder="üîç Buscar por nombre o NIT...">
                    <select id="filter-estado" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                        <option value="suspendido">Suspendido</option>
                    </select>
                </div>
                <div class="table-container">
                    <table class="data-table" id="empresas-table">
                        <thead>
                            <tr>
                                <th>NIT</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Certificado</th>
                                <th>Resoluci√≥n</th>
                                <th>Documento</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="empresas-tbody">
                            <!-- Las empresas se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vista Notificaciones -->
            <div id="view-notificaciones" class="view">
                <div class="notifications-container" id="notificaciones-container">
                    <!-- Las notificaciones se cargar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Vista Triggers -->
            <div id="view-triggers" class="view">
                <div class="triggers-header">
                    <div class="triggers-nav">
                        <button class="btn btn-tab active" data-trigger-tab="lista" onclick="showTriggersTab('lista')">üìã Triggers</button>
                        <button class="btn btn-tab" data-trigger-tab="historial" onclick="showTriggersTab('historial')">üìä Historial</button>
                    </div>
                    <button class="btn btn-primary" onclick="showTriggerModal()">‚ûï Nuevo Trigger</button>
                </div>
                
                <!-- Tab de lista de triggers -->
                <div id="triggers-tab-lista" class="triggers-tab active">
                    <div class="triggers-container" id="triggers-container">
                        <!-- Los triggers se cargar√°n aqu√≠ -->
                    </div>
                </div>
                
                <!-- Tab de historial -->
                <div id="triggers-tab-historial" class="triggers-tab" style="display: none;">
                    <div class="historial-filters">
                        <select id="historial-trigger-filter" class="filter-select" onchange="loadHistorial()">
                            <option value="">Todos los triggers</option>
                        </select>
                        <select id="historial-limit" class="filter-select" onchange="loadHistorial()">
                            <option value="50">√öltimas 50 ejecuciones</option>
                            <option value="100" selected>√öltimas 100 ejecuciones</option>
                            <option value="200">√öltimas 200 ejecuciones</option>
                        </select>
                    </div>
                    <div id="historial-container" class="historial-container">
                        <!-- El historial se cargar√° aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Vista Formulario -->
            <div id="view-formulario" class="view">
                <div class="form-container">
                    <form id="empresa-form" class="card">
                        <h3>Informaci√≥n de la Empresa</h3>
                        
                        <div class="form-group">
                            <label for="nit">NIT *</label>
                            <input type="text" id="nit" name="nit" required>
                        </div>

                        <div class="form-group">
                            <label for="nombre">Nombre *</label>
                            <input type="text" id="nombre" name="nombre" required>
                        </div>

                        <div class="form-group">
                            <label for="estado">Estado *</label>
                            <select id="estado" name="estado" required>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                                <option value="suspendido">Suspendido</option>
                            </select>
                        </div>

                        <h3>Certificado</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="tiene_certificado" name="tiene_certificado">
                            <label for="tiene_certificado">Tiene certificado</label>
                        </div>

                        <div class="form-group" id="group-certificado" style="display: none;">
                            <label for="fecha_vencimiento_certificado">Fecha de Vencimiento</label>
                            <input type="date" id="fecha_vencimiento_certificado" name="fecha_vencimiento_certificado">
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="certificado_renovado" name="certificado_renovado">
                                <label for="certificado_renovado">Renovado</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="certificado_facturado" name="certificado_facturado">
                                <label for="certificado_facturado">Facturado</label>
                            </div>
                        </div>

                        <h3>Resoluci√≥n</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="tiene_resolucion" name="tiene_resolucion">
                            <label for="tiene_resolucion">Tiene resoluci√≥n</label>
                        </div>

                        <div class="form-group" id="group-resolucion" style="display: none;">
                            <label for="fecha_vencimiento_resolucion">Fecha de Vencimiento</label>
                            <input type="date" id="fecha_vencimiento_resolucion" name="fecha_vencimiento_resolucion">
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="resolucion_renovado" name="resolucion_renovado">
                                <label for="resolucion_renovado">Renovado</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="resolucion_facturado" name="resolucion_facturado">
                                <label for="resolucion_facturado">Facturado</label>
                            </div>
                        </div>

                        <h3>Documento</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="tiene_documento" name="tiene_documento">
                            <label for="tiene_documento">Tiene documento</label>
                        </div>

                        <div class="form-group" id="group-documento" style="display: none;">
                            <label for="fecha_vencimiento_documento">Fecha de Vencimiento</label>
                            <input type="date" id="fecha_vencimiento_documento" name="fecha_vencimiento_documento">
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="documento_renovado" name="documento_renovado">
                                <label for="documento_renovado">Renovado</label>
                            </div>
                            
                            <div class="checkbox-group">
                                <input type="checkbox" id="documento_facturado" name="documento_facturado">
                                <label for="documento_facturado">Facturado</label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                            <button type="reset" class="btn btn-secondary">üîÑ Limpiar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Vista Importaci√≥n -->
            <div id="view-importacion" class="view">
                <div class="card">
                    <h2>üì• Importaci√≥n Masiva de Empresas</h2>
                    
                    <div class="importacion-info">
                        <h4>‚ÑπÔ∏è Instrucciones:</h4>
                        <ul>
                            <li>Descarga la plantilla Excel con el formato correcto</li>
                            <li>Completa los datos de las empresas en el archivo</li>
                            <li>Sube el archivo para importar masivamente</li>
                            <li>Las empresas existentes (mismo NIT) ser√°n actualizadas</li>
                            <li>Las empresas nuevas ser√°n creadas</li>
                        </ul>
                    </div>

                    <div class="importacion-section">
                        <h3>Paso 1: Descargar Plantilla</h3>
                        <p>Descarga la plantilla Excel con el formato y ejemplos:</p>
                        <div class="importacion-actions">
                            <button class="btn btn-success" onclick="window.importacionManager.descargarPlantilla()">
                                üì• Descargar Plantilla Excel
                            </button>
                        </div>
                    </div>

                    <div class="importacion-section">
                        <h3>Paso 2: Importar Archivo</h3>
                        <p>Selecciona el archivo Excel completado para importar:</p>
                        <div class="importacion-actions">
                            <button class="btn btn-primary" onclick="window.importacionManager.seleccionarArchivo()">
                                üì§ Seleccionar y Cargar Excel
                            </button>
                        </div>
                    </div>

                    <div class="importacion-info" style="background-color: #fef3c7; border-left-color: #f59e0b;">
                        <h4>‚ö†Ô∏è Importante:</h4>
                        <ul>
                            <li>El archivo debe ser formato Excel (.xlsx o .xls)</li>
                            <li>No modifiques los nombres de las columnas</li>
                            <li>Las fechas deben estar en formato YYYY-MM-DD o DD/MM/YYYY</li>
                            <li>Los campos booleanos aceptan: SI, NO, 1, 0, X</li>
                            <li>El NIT y Raz√≥n Social son obligatorios</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast para notificaciones -->
    <div id="toast" class="toast"></div>

    <!-- Modal para Trigger -->
    <div id="trigger-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTriggerModal()">&times;</span>
            <h2 id="trigger-modal-title">Nuevo Trigger</h2>
            <form id="trigger-form">
                <input type="hidden" id="trigger-id">
                
                <div class="form-group">
                    <label for="trigger-nombre">Nombre *</label>
                    <input type="text" id="trigger-nombre" required>
                </div>

                <div class="form-group">
                    <label for="trigger-descripcion">Descripci√≥n</label>
                    <textarea id="trigger-descripcion" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="trigger-frecuencia">Frecuencia *</label>
                    <select id="trigger-frecuencia" required onchange="updateFrecuenciaFields()">
                        <option value="diaria">Diaria</option>
                        <option value="semanal">Semanal</option>
                        <option value="mensual">Mensual</option>
                        <option value="personalizada">Personalizada (horas)</option>
                    </select>
                </div>

                <div class="form-group" id="group-hora">
                    <label for="trigger-hora">Hora de ejecuci√≥n *</label>
                    <input type="time" id="trigger-hora" value="08:00">
                </div>

                <div class="form-group" id="group-dias-semana" style="display: none;">
                    <label>D√≠as de la semana</label>
                    <div class="checkbox-group-inline">
                        <label><input type="checkbox" value="lunes"> Lunes</label>
                        <label><input type="checkbox" value="martes"> Martes</label>
                        <label><input type="checkbox" value="miercoles"> Mi√©rcoles</label>
                        <label><input type="checkbox" value="jueves"> Jueves</label>
                        <label><input type="checkbox" value="viernes"> Viernes</label>
                        <label><input type="checkbox" value="sabado"> S√°bado</label>
                        <label><input type="checkbox" value="domingo"> Domingo</label>
                    </div>
                </div>

                <div class="form-group" id="group-dia-mes" style="display: none;">
                    <label for="trigger-dia-mes">D√≠a del mes *</label>
                    <input type="number" id="trigger-dia-mes" min="1" max="31" value="1">
                </div>

                <div class="form-group" id="group-intervalo" style="display: none;">
                    <label for="trigger-intervalo">Intervalo (horas) *</label>
                    <input type="number" id="trigger-intervalo" min="1" max="24" value="1">
                </div>

                <div class="form-group">
                    <label for="trigger-destinatarios">Destinatarios (separados por comas) *</label>
                    <textarea id="trigger-destinatarios" rows="2" required placeholder="correo1@ejemplo.com, correo2@ejemplo.com"></textarea>
                </div>

                <div class="form-group">
                    <label>Prioridades a incluir</label>
                    <div class="checkbox-group-inline">
                        <label><input type="checkbox" value="CRITICA" checked> üö® Cr√≠ticas</label>
                        <label><input type="checkbox" value="ALTA" checked> ‚ö†Ô∏è Altas</label>
                        <label><input type="checkbox" value="MEDIA" checked> ‚ÑπÔ∏è Medias</label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTriggerModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../static/js/auth.js"></script>
    <script src="../static/js/api.js"></script>
    <script src="../static/js/dashboard.js"></script>
    <script src="../static/js/empresas.js"></script>
    <script src="../static/js/notificaciones.js"></script>
    <script src="../static/js/triggers.js"></script>
    <script src="../static/js/historial.js"></script>
    <script src="../static/js/formulario.js"></script>
    <script src="../static/js/importacion.js"></script>
    <script src="../static/js/main.js"></script>
    
    <script>
        // Mostrar informaci√≥n del usuario en la UI
        document.addEventListener('DOMContentLoaded', () => {
            const usuario = Auth.getUsuario();
            if (usuario) {
                document.getElementById('user-name').textContent = usuario.nombre || usuario.username;
            }
        });
    </script>
</body>
</html>
